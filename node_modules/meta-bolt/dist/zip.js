"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.zipPackage = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const archiver_1 = __importDefault(require("archiver"));
const lib_1 = require("./lib");
const createZip = (src, dst, name) => {
    return new Promise((resolve, reject) => {
        const archive = (0, archiver_1.default)("zip");
        const zipDest = path_1.default.join(dst, `${name}.zip`);
        const output = fs_1.default.createWriteStream(zipDest);
        output.on("close", () => {
            resolve(zipDest);
        });
        archive.on("error", (err) => {
            reject(err.message);
        });
        archive.pipe(output);
        archive.directory(src, false);
        archive.finalize();
    });
};
const zipPackage = async (zipName, dest, src, assetDirs, srcSubFolder) => {
    fs_1.default.mkdirSync(dest, { recursive: true });
    const tmpDir = path_1.default.join(dest, "tmp");
    fs_1.default.mkdirSync(tmpDir, { recursive: true });
    const tmpSrcDir = srcSubFolder ? path_1.default.join(tmpDir, zipName) : src;
    if (srcSubFolder) {
        fs_1.default.mkdirSync(tmpSrcDir, { recursive: true });
        console.log({ src, tmpSrcDir });
        fs_1.default.readdirSync(src).map((file) => {
            fs_1.default.cpSync(path_1.default.join(src, file), path_1.default.join(tmpSrcDir, file), {
                recursive: true,
            });
        });
    }
    else {
        fs_1.default.readdirSync(src).map((file) => {
            fs_1.default.cpSync(path_1.default.join(src, file), path_1.default.join(tmpDir, file), {
                recursive: true,
            });
        });
    }
    if (assetDirs) {
        assetDirs.map((assetDir) => {
            if (assetDir.endsWith("/*")) {
                const assetPath = path_1.default.join(assetDir.replace("/*", ""));
                fs_1.default.readdirSync(assetPath).map((file) => {
                    fs_1.default.cpSync(path_1.default.join(assetPath, file), path_1.default.join(tmpDir, file), {
                        recursive: true,
                    });
                });
            }
            else {
                fs_1.default.cpSync(path_1.default.join(assetDir), path_1.default.join(tmpDir, assetDir), {
                    recursive: true,
                });
            }
        });
    }
    const zip = await createZip(tmpDir, dest, zipName);
    (0, lib_1.log)("built zip", true, zip);
    fs_1.default.rmSync(tmpDir, { recursive: true });
    (0, lib_1.resetLog)();
    return zip;
};
exports.zipPackage = zipPackage;
