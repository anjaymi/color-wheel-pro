"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.hotReloadServer = exports.wsUpdate = void 0;
const http = require("http");
const ws_1 = require("ws");
let clients = new Set();
let server = null;
const wsUpdate = (id) => {
    console.log(`\n⚡ Trigger hot reload (for ${clients.size} clients)`);
    const message = JSON.stringify({
        id: id,
        status: "updated",
    });
    for (let client of clients) {
        if (client.readyState === ws_1.WebSocket.OPEN) {
            client.send(message);
        }
    }
};
exports.wsUpdate = wsUpdate;
const hotReloadServer = (hotReloadPort) => {
    if (server)
        return;
    server = http.createServer((req, res) => {
        res.writeHead(404, { "Content-Type": "text/plain" });
        res.end("Not Found");
    });
    const wss = new ws_1.WebSocketServer({ server });
    wss.on("connection", (ws) => {
        clients.add(ws);
        ws.on("message", (message) => console.log("Received:", message));
        ws.on("close", () => {
            clients.delete(ws);
        });
    });
    server.listen(hotReloadPort, () => {
        console.log(`⚡ Hot reload ws server started on port ${hotReloadPort}`);
    });
};
exports.hotReloadServer = hotReloadServer;
